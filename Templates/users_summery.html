{% extends "base.html" %}

{% block style %}
<link rel="stylesheet" href="{{url_for('static',filename='css/base.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/user_summery.css')}}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
{% include "admin_sidebar.html" %}

<div class="content">
    <div class="page-header bg">
        <div class="header-content">
            <h1>User Management</h1>
            <p>Monitor and manage user activities across your parking system</p>
        </div>
        <div class="tab-navigation">
            <button class="tab-btn {% if active_tab == 'users' %}active{% endif %}" id="users-tab" onclick="document.querySelector('.booking').style.display='none';
            document.querySelector('.users').style.display='block';
            document.querySelector('#booking-tab').classList.remove('active');
            document.querySelector('#users-tab').classList.add('active');">
                <i class="fas fa-users"></i>
                <span>Users Overview</span>
            </button>
            <button class="tab-btn {% if active_tab == 'booking' %}active{% endif %}" id="booking-tab" onclick="document.querySelector('.booking').style.display='block';
            document.querySelector('.users').style.display='none';
            document.querySelector('#booking-tab').classList.add('active');
            document.querySelector('#users-tab').classList.remove('active');">
                <i class="fas fa-history"></i>
                <span>Booking Summary</span>
            </button>
        </div>
    </div>

    <div class="users "style="display: {{ 'block' if active_tab == 'users' else 'none' }}">
        <div class="search-section">
            <form action="{{url_for('admin.users_summery')}}" method="get">
                <input type="hidden" name="tab" value="users">

                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="userSearch" name="search" required placeholder="Search users by name, email, or ID...">
                    </div>
                
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                        Search
                    </button>
                    <div class="filter-controls">
                        
                        <button class="export-btn" onclick="window.print()">
                            <i class="fas fa-download"></i>
                            Print
                        </button>
                    </div>
                </div>
            </form>
        </div>
        {% if not users %}
    
        <div class="empty-state ">
            <div class="empty-icon">
                <i class="fas fa-history"></i>
            </div>
            <h3>No User History</h3>
            
        </div>
        {% else %}
        <div class="table-container">
            <div class="table-header">
                <h3>User Summary</h3>
                <div class="table-actions">
                    <span class="record-count">{{ user_length|length -1 }} records</span>
                    <a href="{{url_for('admin.users_summery')}}">
                        <button class=" btn-style" id="refresh-btn" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>

                    </a>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>S.No</th>
                            <th>Name</th>
                            <th>Registration Date</th>
                            <th>Total Parkings</th>
                            <th>Current Status</th>
                            <th>Spot Number</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                            {% if not user.is_admin %}
                                <tr class="row">
                                    <td>{{user.id-1}}</td>
                                    <td>{{ user.full_name }}</td>
                                    <td>{{ user.registration_date.strftime("%d %b %Y")}}</td>
                                    <td>{{ user.total_parkings  }}</td>

                                    {% set ns = namespace(has_booking=false, current_spot_number='NA') %}

                                    {%for booking in bookings %}
                                        {%if booking.user_id == user.id %}
                                            {% set ns.has_booking = true %}
                                            {%for spot in spots%}
                                                {% if spot.id == booking.spot_id %}
                                                    {% set ns.current_spot_number = spot.spot_number %}
                                                {% endif %}
                                                
                                            {%endfor%}
                                        {% endif %}
                                    {%endfor%}

                                    {%if ns.has_booking%}
                                        <td>Active</td>
                                        <td>{{ns.current_spot_number}}</td>
                                            
                                    {% else %}
                                        <td>Inactive</td>
                                        <td>NA</td>
                                            
                                    {%endif%}
                               
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {%endif%}
    </div>
    <div class="booking "style="display: {{ 'block' if active_tab == 'booking' else 'none' }};">
        <div class="search-section">
           <form action="{{url_for('admin.users_summery')}}" method="get">
            <input type="hidden" name="tab" value="booking">

                <div class="search-container">
                
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="userSearch" name="search_booking" required placeholder="Search users by name, email, or ID...">
                    </div>
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                        Search
                    </button>
                    
                    <div class="filter-controls">
                        <select name="search_filter" >
                                <option value="booking_id">Booking ID</option>
                                <option value="user_id">User Id</option>
                                <option value="lot_name">Lot Name</option>
                                <option value="spot_number">Spot No</option>
                        </select>
                        <button class="export-btn" onclick="window.print()">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>
            </form>
        </div>
        {% if not history %}
        <div class="empty-state ">
            <div class="empty-icon">
                <i class="fas fa-history"></i>
            </div>
            <h3>No Booking History</h3>
            
        </div>
        {% else %}
        <div class="table-container">
            <div class="table-header">
                <h3>Booking Summary</h3>
                <div class="table-actions">
                    <span class="record-count">{{ history|length }} records</span>
                    <a href="{{url_for('admin.users_summery')}}">
                        <button class="refresh-btn" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </a>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>User ID</th>
                            <th>Parking Lot Name</th>
                            <th>Spot Number</th>
                            <th>Parking Time</th>
                            <th>Exit Time</th>
                            <th>Amount Paid</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in history %}
                        <tr class="row">
                            <td>{{ record.booking_id }}</td>
                            <td>{{record.user_id}}</td>
                            {% for lot in lots %}
                                {% if lot.id == record.lot_id %}
                                    <td>{{ lot.name }}</td>
                                {% endif %}
                            {% endfor %}
                            {% for spot in spots %}
                                {% if spot.id == record.spot_id %}
                                    <td>{{ spot.spot_number }}</td>
                                {% endif %}
                            {% endfor %}
                            <td>{{ record.entry_time.strftime("%I:%M %p") }}</td>
                            <td>{{ record.exit_time.strftime("%I:%M %p")}}</td>    
                            <td>₹{{ record.total_amount_paid  }}</td>
                            
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {%endif%}
    </div>
</div>


{% endblock %}
