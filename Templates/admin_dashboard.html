{%extends "base.html" %}

{%block style%}
<link rel="stylesheet" href="{{url_for('static',filename='css/admin_dashboard.css')}}">

<link rel="stylesheet" href="{{url_for('static',filename='css/modal.css')}}">

{%endblock%}

{%block content %}
    <div class="dashboard-container">
        {% include 'admin_sidebar.html' %}
        <div class="main-content">

            <div class="content-header">
                <div class="header-left">
                    <h1>Dashboard Overview</h1>
                    <p>Welcome back! Here's what's happening with your parking system today.</p>
                </div>
                <div class="header-right">
                        <button class="refresh-btn" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>

                </div>
            </div>

            <div class="grid-section">
                <div class="grid-card primary">
                    <div class="grid-icon">
                        <i class="fa-solid fa-square-parking"></i>
                    </div>
                    <div class="grid-content">
                        <h3>{{lots|length}}</h3>
                        <p>Total Parking Lots</p>
                        <span class="grid-change positive">
                            <i class="fas fa-arrow-up"></i>
                            +2 this month
                        </span>
                    </div>
                </div>
                
                <div class="grid-card success">
                    <div class="grid-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="grid-content">
                        <h3>{{total_regular_spots}}</h3>
                        <p>Total Regular Parking Spots</p>
                        <span class="grid-change positive">
                            <i class="fas fa-check-circle"></i>
                            {{total_regular_available_spots}} available
                        </span>
                    </div>
                </div>
                
                <div class="grid-card info">
                    <div class="grid-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="grid-content">
                        <h3>{{total_users}}</h3>
                        <p>Registered Users</p>
                        <span class="grid-change positive">
                            <i class="fas fa-arrow-up"></i>
                            +15 this week
                        </span>
                    </div>
                </div>
                
                <div class="grid-card warning">
                    <div class="grid-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="grid-content">
                        <h3>{{active_bookings}}</h3>
                        <p>Active Bookings</p>
                        <span class="grid-change neutral">
                            <i class="fas fa-clock"></i>
                            78 today
                        </span>
                    </div>
                </div>
                
                <div class="grid-card electric">
                    <div class="grid-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="grid-content">
                        <h3>{{total_ev_spots}}</h3>
                        <p>EV Charging Spots</p>
                        <span class="grid-change positive">
                            <i class="fas fa-battery-full"></i>
                            {{total_ev_available_spots }} available
                        </span>
                    </div>
                </div>
                
                <div class="grid-card revenue">
                    <div class="grid-icon">
                        <i class="fas fa-rupee-sign"></i>
                    </div>
                    <div class="grid-content">
                        <h3>₹10</h3>
                        <p>Today's Revenue</p>
                        <span class="grid-change positive">
                            <i class="fas fa-trending-up"></i>
                            +12% vs yesterday
                        </span>
                    </div>
                </div>
            </div>

            <div class="search-section">
                <button class="add-lot-btn" id="add_parking_lot">
                    <i class="fas fa-plus"></i>
                        Add First Parking Lot
                </button>
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="search" placeholder="Search parking lots, users, bookings...">
                    </div>
                    <select class="filter-select">
                        <option>By User ID</option>
                        <option>By Location</option>
                        <option>By Status</option>
                    </select>
                </div>
            </div>

            <div class="parking-lots-section">
                <div class="section-header">
                    <h2>Parking Lots Management</h2>
                </div>
                
                <div class="parking-lots-card-container">
                    {% if not lots %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <h3>No Parking Lots Yet</h3>
                        <p>Start by adding your first parking lot to the system.</p>
                        
                    </div>
                    {% endif %}
                    
                    {% for lot in lots %}
                    <div class="parking-lot-card">
                        <div class="card-header">
                            <div class="lot-status">
                                {% if lot.total_spots + lot.ev_spots == lot.occupied_regular_spots + lot.occupied_ev_spots %}
                                    <div class="full lot-status">
                                        Full
                                    </div>
                                {% else %}
                                    <div class="active lot-status">
                                        Active
                                    </div>
                                {% endif %}
                            </div>
                            <div class="card-actions">
                                <a href="{{ url_for('admin.admin_dashboard', lot_id=lot.id) }}" 
                                   class="action-btn edit-lot ">
                                    <i class="fas fa-edit edit-lot"></i>
                                </a>
                                <form action="{{url_for('parking.view_details')}}" method="post">
                                    <input type="hidden" value={{lot.id}} name="lot_id">
                                    <button class="action-btn view"><i class="fas fa-eye"></i></button> 
                                </form>

                                <a href="{{ url_for('parking.delete_lot', lot_id=lot.id) }}" 
                                   class="action-btn delete"
                                   onclick="return confirm('Are you sure you want to delete this parking lot?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                        
                        <div class="card-content">
                            <h3>{{ lot.name }}</h3>
                            <p class="lot-address">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ lot.address }}
                            </p>
                            <p class="lot-pincode">PIN: {{ lot.pincode }}</p>
                            
                            <div class="lot-stats">
                                <div class="stat">
                                    <span class="stat-value">₹{{ lot.hourly_rate }}</span>
                                    <span class="stat-label">per hour</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value">{{ lot.total_spots }}</span>
                                    <span class="stat-label">total spots</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value">{{ lot.total_spots-lot.occupied_regular_spots}}</span>
                                    <span class="stat-label">available</span>
                                </div>
                            </div>
                            
                            {% if lot.ev_spots > 0 %}
                            <div class="ev-info">
                                <i class="fas fa-bolt"></i>
                                <span>{{ lot.ev_spots }} EV spots • ₹{{ lot.ev_charging_rate }}/kWh</span>
                            </div>
                            {% endif %}
                            
                            <div class="lot-hours">
                                {% if lot.is_24_hours %}
                                    <i class="fas fa-clock"></i>
                                    <span>24/7 Open</span>
                                {% else %}
                                    <i class="fas fa-clock"></i>
                                    <span>{{ lot.opening_time }} - {{ lot.closing_time }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <div class="occupancy-bar">
                                <div class="occupancy-fill" style="width: {{ ((lot.occupied_regular_spots + lot.occupied_ev_spots) / (lot.total_spots + lot.ev_spots) * 100) if (lot.total_spots + lot.ev_spots) > 0 else 0 }}%">
                                </div>
                            </div>
                            <span class="occupancy-text">
                                {{ (((lot.occupied_regular_spots + lot.occupied_ev_spots) /(lot.total_spots + lot.ev_spots) * 100) | round(1)) if (lot.total_spots + lot.ev_spots) > 0 else 0 }}% occupied
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="add-parking-lot-modal background-effect" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Parking Lot</h2>
                <button class="close-modal close-add-parking-lot-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        
            <form action="{{ url_for('parking.parking_dashboard')}}" method="POST" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="pl_name">
                            <i class="fas fa-building"></i>
                            Parking Lot Name
                        </label>
                        <input type="text" id="pl_name" name="pl_name" required 
                                placeholder="Enter parking lot name">
                    </div>
                    <div class="form-group">
                        <label for="pincode">
                            <i class="fas fa-map-pin"></i>
                            Pincode
                        </label>
                        <input type="text" id="pincode" name="pincode" required 
                                placeholder="Enter pincode">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="address">
                        <i class="fas fa-map-marker-alt"></i>
                        Full Address
                    </label>
                    <input type="text" id="address" name="address" required 
                            placeholder="Enter complete address">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="total_spots">
                            <i class="fas fa-car"></i>
                            Total Regular Spots
                        </label>
                        <input type="number" id="total_spots" name="total_spots" required 
                                placeholder="50">
                    </div>
                    <div class="form-group">
                        <label for="hourly_rate">
                            <i class="fas fa-rupee-sign"></i>
                            Hourly Rate (₹)
                        </label>
                        <input type="number" step="any" id="hourly_rate" name="hourly_rate" required placeholder="50">
                    </div>
                    
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ev_spots">
                            <i class="fas fa-bolt"></i>
                            EV Charging Spots
                        </label>
                        <input type="number" id="ev_spots" name="ev_spots" required 
                                placeholder="10">
                    </div>
                    <div class="form-group">
                        <label for="ev_charging_rate">
                            <i class="fas fa-battery-full"></i>
                            EV Rate (₹/kWh)
                        </label>
                        <input type="number" step="any" id="ev_charging_rate" name="ev_charging_rate" required placeholder="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="radio-group-label">
                        <i class="fas fa-clock"></i>
                        Operating Hours
                    </label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="is_24_hours" value="1"  required>
                            <span class="radio-custom"></span>
                            24 Hours
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="is_24_hours" value="0" >
                            <span class="radio-custom"></span>
                            Custom Hours
                        </label>
                    </div>
                </div>
                
                <div class="time-fields" id="time-field" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="opening_time">
                                <i class="fas fa-sun"></i>
                                Opening Time
                            </label>
                            <input type="time" id="opening_time" name="opening_time">
                        </div>
                        <div class="form-group">
                            <label for="closing_time">
                                <i class="fas fa-moon"></i>
                                Closing Time
                            </label>
                            <input type="time" id="closing_time" name="closing_time">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">
                        <i class="fas fa-align-left"></i>
                        Description
                    </label>
                    <textarea id="description" name="description" rows="3" 
                                placeholder="Enter parking lot description..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary close-add-parking-lot-modal">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        Add Parking Lot
                    </button>
                </div>
            </form>
    </div>
    </div>

    {% if lot %}
    <div class="background-effect edit-parking-lot-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Parking Lot</h2>
                <a href="{{url_for('admin.admin_dashboard')}}" class="close-edit-lot-model">
                    <i class="fas fa-times"></i>
                </a>
            </div>
            
            <form action="{{url_for('parking.update_lot',lot_id=lot.id)}}" method="POST" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_pl_name">
                            <i class="fas fa-building"></i>
                            Parking Lot Name
                        </label>
                        <input type="text" id="edit_pl_name" name="pl_name" value="{{lot.name}}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_pincode">
                            <i class="fas fa-map-pin"></i>
                            Pincode
                        </label>
                        <input type="text" id="edit_pincode" name="pincode" value="{{lot.pincode}}" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit_address">
                        <i class="fas fa-map-marker-alt"></i>
                        Full Address
                    </label>
                    <input type="text" id="edit_address" name="address" value="{{lot.address}}" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_hourly_rate">
                            <i class="fas fa-rupee-sign"></i>
                            Hourly Rate (₹)
                        </label>
                        <input type="number" step="any" id="edit_hourly_rate" name="hourly_rate" value="{{lot.hourly_rate}}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_ev_charging_rate">
                            <i class="fas fa-battery-full"></i>
                            EV Rate (₹/kWh)
                        </label>
                        <input type="number" step="any" id="edit_ev_charging_rate" name="ev_charging_rate" value="{{lot.ev_charging_rate}}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_total_spots">
                            <i class="fas fa-car"></i>
                            Total Regular Spots
                        </label>
                        <input type="number" id="edit_total_spots" name="total_spots" value="{{lot.total_spots}}" disabled>
                       
                    </div>
                    <div class="form-group">
                        <label for="edit_ev_spots">
                            <i class="fas fa-bolt"></i>
                            EV Charging Spots
                        </label>
                        <input type="number" id="edit_ev_spots" name="ev_spots" value="{{lot.ev_spots}}" disabled>
                       
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit_description">
                        <i class="fas fa-align-left"></i>
                        Description
                    </label>
                    <textarea id="edit_description" name="description" rows="3">{{lot.description}}</textarea>
                </div>
                
                <div class="form-actions">
                    <a href="{{url_for('admin.admin_dashboard')}}" class="btn-secondary close-edit-lot-model">Cancel</a>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i>
                        Update Parking Lot
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if lot %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editModal = document.querySelector('.edit-parking-lot-modal');
            const page = document.querySelector('.main-content');

            if (editModal) {
                editModal.style.display = 'block';
                
            }
        });
    </script>
    {% endif %}



<script src="{{url_for('static',filename='js/admin_dashboard.js')}}"></script>
{%endblock%}